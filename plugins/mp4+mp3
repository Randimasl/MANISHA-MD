const { default: makeWASocket, DisconnectReason } = require("@adiwajshing/baileys");
const fs = require("fs");
const ytdl = require("ytdl-core");

// Bot Start Function
const startBot = () => {
    const sock = makeWASocket();

    sock.ev.on("messages.upsert", async (msg) => {
        const message = msg.messages[0];
        if (!message.message) return;

        const from = message.key.remoteJid;
        const text = message.message.conversation;

        // Check if message starts with "song" (e.g., "song https://youtu.be/...")
        if (text.startsWith("song ")) {
            const url = text.split(" ")[1];
            if (!ytdl.validateURL(url)) {
                sock.sendMessage(from, { text: "වලංගු YouTube ලින්ක් එකක් ලබාදෙන්න!" });
                return;
            }

            sock.sendMessage(from, { text: "ගීතය ඩවුන්ලෝඩ් වෙමින් පවතී..." });

            const stream = ytdl(url, { filter: "audioonly" });
            const fileName = `song_${Date.now()}.mp3`;
            const filePath = `./${fileName}`;

            // Save the song and send it back
            stream.pipe(fs.createWriteStream(filePath)).on("finish", () => {
                sock.sendMessage(
                    from,
                    { document: { url: filePath }, mimetype: "audio/mpeg", fileName: "song.mp3" }
                );
                fs.unlinkSync(filePath); // Clean up the file
            });
        }
    });

    sock.ev.on("connection.update", (update) => {
        const { connection, lastDisconnect } = update;
        if (connection === "close") {
            const reason = new Boom(lastDisconnect?.error)?.output?.statusCode;
            if (reason === DisconnectReason.loggedOut) {
                console.log("Device Logged Out");
            } else {
                startBot();
            }
        } else if (connection === "open") {
            console.log("WhatsApp Bot Connected");
        }
    });
};

// Start the Bot
startBot();
